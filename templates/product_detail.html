{% extends "base.html" %}
{% block title %}{{ product.product_name }} - Eximmart{% endblock %}

{% block content %}
<div class="container my-2">
  <div class="row">
    <!-- Image/Video Gallery -->
    <div class="col-md-6">
      <div id="mediaCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="120000">
        <div class="carousel-inner">
          {% if product.product_image1 %}
          <div class="carousel-item active" data-index="0">
            <div class="zoom-container">
              <img src="{{ url_for('static', filename=product.product_image1) }}" class="d-block w-100" />
            </div>
          </div>
          {% endif %}
          {% if product.product_image2 %}
          <div class="carousel-item" data-index="1">
            <div class="zoom-container">
              <img src="{{ url_for('static', filename=product.product_image2) }}" class="d-block w-100" />
            </div>
          </div>
          {% endif %}
          {% if product.product_image3 %}
          <div class="carousel-item" data-index="2">
            <div class="zoom-container">
              <img src="{{ url_for('static', filename=product.product_image3) }}" class="d-block w-100" />
            </div>
          </div>
          {% endif %}
          {% if product.product_video %}
          <div class="carousel-item" data-index="3">
            <video class="d-block w-100" controls>
              <source src="{{ url_for('static', filename=product.product_video) }}" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Thumbnail carousel -->
      <div id="thumbCarousel">
        <span id="thumbPrev" class="thumb-arrow">&#10094;</span>
        
        {% if product.product_image1 %}
        <div class="thumb-item active" data-index="0">
          <img src="{{ url_for('static', filename=product.product_image1) }}" />
        </div>
        {% endif %}
        {% if product.product_image2 %}
        <div class="thumb-item" data-index="1">
          <img src="{{ url_for('static', filename=product.product_image2) }}" />
        </div>
        {% endif %}
        {% if product.product_image3 %}
        <div class="thumb-item" data-index="2">
          <img src="{{ url_for('static', filename=product.product_image3) }}" />
        </div>
        {% endif %}
        {% if product.product_video %}
        <div class="thumb-item" data-index="3">
          <video>
            <source src="{{ url_for('static', filename=product.product_video) }}" type="video/mp4" />
          </video>
        </div>
        {% endif %}

        <span id="thumbNext" class="thumb-arrow">&#10095;</span>
      </div>
    </div>

    <!-- Product Info -->
    <div class="col-md-6 product-info">
      <h3>{{ product.product_name }}</h3>
      <h4 class="product-price mt-3 mb-4">${{ '%.2f'|format(product.price) }}</h4>

      <!-- Brand Name -->
      <div class="input-group mb-2" style="width:225px;">
        <span class="input-group-text">Brand</span>
        <input type="text" class="form-control text-center" value="{{ product.brand_name or 'N/A' }}" readonly />
      </div>

      <!-- Product Color -->
      <div class="input-group mb-2" style="width:225px;">
        <span class="input-group-text">Color</span>
        <input type="text" class="form-control text-center" value="{{ product.product_color or 'N/A' }}" readonly />
      </div>

      <!-- Sold -->
      <div class="input-group mb-2" style="width:225px;">
        <span class="input-group-text">Sold</span>
        <input type="text" class="form-control text-center" value="{{ product.sold }}" readonly />
      </div>

      <!-- Stock -->
      <div class="input-group mb-2" style="width:225px;">
        <span class="input-group-text">Stock</span>
        <input type="text" class="form-control text-center" value="{{ product.stock }}" readonly />
      </div>

<!-- Quantity and Add to Cart Form -->
<form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="post" style="margin-bottom: 0;">
  <div class="input-group mb-3" style="width: 225px;">
    <span class="input-group-text">Quantity</span>
    <button
      class="btn btn-outline-secondary"
      style="border-radius: 0.375rem 0 0 0.375rem;"
      type="button"
      id="decrease"
    >-</button>
    <input
      type="text"
      id="quantity"
      name="quantity"
      class="form-control text-center"
      value="1"
      min="1"
      max="{{ product.stock or 0 }}"
      data-stock="{{ product.stock or 0 }}"
      required
    />
    <button
      class="btn btn-outline-secondary"
      type="button"
      id="increase"
    >+</button>
  </div>
  <div
    id="qtyErrorMsg"
    style="color: red; font-size: 0.9rem; display: none; margin-top: -5px; margin-bottom: 5px"
  ></div>

  <!-- Total Price -->
  <div class="mb-3" id="totalPrice" data-price="{{ product.price | default(0) }}">
    Total: ${{ '%.2f'|format(product.price or 0) }}
  </div>

  <!-- Buttons wrapper: flex দিয়ে পাশাপাশি রাখা -->
  <div style="display: flex; gap: 10px; align-items: center;">
    <button class="btn btn-primary me-2" type="button">Order Now</button>
    <button type="submit" class="btn btn-warning">Add to Cart</button>
  </div>
</form>


    </div>
  </div>

  <!-- Description Section -->
  <div class="row mt-5 pt-5">
    <div class="col-12 px-0">
      <div class="card shadow-sm">
        <div
          class="card-header fw-bold"
          style="background: #f8f9fa; border-radius: 8px 8px 0 0"
        >
          Product Description
        </div>
        <div class="card-body">
          <p class="mb-3">{{ product.description }}</p>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
const totalPriceDiv = document.getElementById("totalPrice");
const price = parseFloat(totalPriceDiv.getAttribute("data-price")) || 0;

const quantityInput = document.getElementById("quantity");
const stock = parseInt(quantityInput.getAttribute("data-stock")) || 0;
const errorMsgDiv = document.getElementById("qtyErrorMsg");

function showErrorMessage(msg) {
  errorMsgDiv.textContent = msg;
  errorMsgDiv.style.display = "block";
}

function hideErrorMessage() {
  errorMsgDiv.style.display = "none";
}

function updateTotalPrice() {
  let qty = parseInt(quantityInput.value);
  if (isNaN(qty) || qty < 1) {
    qty = 1;
    quantityInput.value = qty;
  }
  if (qty > stock) {
    qty = stock;
    quantityInput.value = qty;
    showErrorMessage("Your quantity has reached the maximum available stock.");
  } else {
    hideErrorMessage();
  }
  const total = (price * qty).toFixed(2);
  totalPriceDiv.textContent = `Total Price: $${total}`;
}

// Decrease quantity
document.getElementById("decrease").addEventListener("click", function () {
  let qty = parseInt(quantityInput.value);
  if (qty > 1) {
    quantityInput.value = qty - 1;
    updateTotalPrice();
  }
});

// Increase quantity
document.getElementById("increase").addEventListener("click", function () {
  let qty = parseInt(quantityInput.value);
  if (qty < stock) {
    quantityInput.value = qty + 1;
    hideErrorMessage();
    updateTotalPrice();
  } else {
    showErrorMessage("Your quantity has reached the maximum available stock.");
  }
});

// Direct input validation
quantityInput.addEventListener("input", function () {
  let qty = parseInt(quantityInput.value);
  if (isNaN(qty) || qty < 1) {
    qty = 1;
  }
  if (qty > stock) {
    qty = stock;
    showErrorMessage("Your quantity has reached the maximum available stock.");
  } else {
    hideErrorMessage();
  }
  quantityInput.value = qty;
  updateTotalPrice();
});

// Initial price update on page load
updateTotalPrice();

// Zoom container JS
document.querySelectorAll(".zoom-container").forEach((container) => {
  const img = container.querySelector("img");

  container.addEventListener("mousemove", function (e) {
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const xPercent = (x / rect.width) * 100;
    const yPercent = (y / rect.height) * 100;

    img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
  });

  container.addEventListener("mouseenter", function () {
    container.classList.add("zoomed");
  });

  container.addEventListener("mouseleave", function () {
    container.classList.remove("zoomed");
    img.style.transformOrigin = `center center`;
  });
});

// === Thumbnail & Main carousel sync ===
document.addEventListener("DOMContentLoaded", () => {
  const mainCarousel = document.querySelector("#mediaCarousel");
  const carousel = bootstrap.Carousel.getOrCreateInstance(mainCarousel);
  const carouselInner = mainCarousel.querySelector(".carousel-inner");
  const items = carouselInner.querySelectorAll(".carousel-item");

  const thumbs = document.querySelectorAll("#thumbCarousel .thumb-item");
  const thumbPrev = document.getElementById("thumbPrev");
  const thumbNext = document.getElementById("thumbNext");

  function setActiveThumbnail(index) {
    thumbs.forEach((thumb) => {
      thumb.classList.toggle(
        "active",
        parseInt(thumb.getAttribute("data-index")) === index
      );
    });
  }

  // On main carousel slide event, update thumbnail active
  mainCarousel.addEventListener("slid.bs.carousel", (e) => {
    setActiveThumbnail(e.to);
  });

  // On thumbnail click, move main carousel
  thumbs.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      const index = parseInt(thumb.getAttribute("data-index"));
      carousel.to(index);
      setActiveThumbnail(index);
    });
  });

  // Thumbnail left arrow click
  thumbPrev.addEventListener("click", () => {
    let activeIndex = -1;
    thumbs.forEach((thumb, idx) => {
      if (thumb.classList.contains("active")) activeIndex = idx;
    });
    let newIndex = activeIndex > 0 ? activeIndex - 1 : 0;
    carousel.to(newIndex);
    setActiveThumbnail(newIndex);
  });

  // Thumbnail right arrow click
  thumbNext.addEventListener("click", () => {
    let activeIndex = -1;
    thumbs.forEach((thumb, idx) => {
      if (thumb.classList.contains("active")) activeIndex = idx;
    });
    let newIndex =
      activeIndex < thumbs.length - 1 ? activeIndex + 1 : thumbs.length - 1;
    carousel.to(newIndex);
    setActiveThumbnail(newIndex);
  });

  // Initialize active thumbnail
  setActiveThumbnail(0);
});
</script>

{% endblock %}
